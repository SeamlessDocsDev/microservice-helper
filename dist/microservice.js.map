{"version":3,"sources":["../lib/microservice.js"],"names":["doFn","$pipePromise","fnc","state","critical","promise","Promise","resolve","reject","fncCalled","_successHandler","then","fncState","catch","_errorHandler","error","nState","Object","assign","console","warn","$pipe","_generateState","seneca","msg","notAllowedKeys","nMsg","key","indexOf","done","returnData","tryFnc","finalState","ok","data","err"],"mappings":"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","file":"microservice.js","sourcesContent":["class $pipePromise {\n\n  constructor (fnc, state, critical) {\n\n    this.state   = state\n    this.promise = new Promise((resolve, reject) => {\n      try {\n        const fncCalled = fnc(this.state)\n\n        if (!(fncCalled instanceof Promise)) {\n          return this._successHandler(fncCalled, resolve)\n        }\n\n        return fncCalled.then(fncState => {\n          return this._successHandler(fncState, resolve)\n        })\n        .catch(error => {\n          return this._errorHandler(error, critical, reject, resolve)\n        })\n      } catch (error) {\n        return this._errorHandler(error, critical, reject, resolve)\n      }\n    })\n  }\n\n  _successHandler (nState, resolve) {\n    this.state = Object.assign({}, this.state, nState)\n    return resolve(this.state)\n  }\n\n  _errorHandler (error, critical, reject, resolve) {\n    if (critical || this.critical) {\n      this.critical = true\n      return reject(error)\n    }\n    console.warn(error)\n    this.state = Object.assign({}, this.state, {error})\n    return resolve(this.state)\n  }\n\n  then (fnc, critical) {\n    this.promise = this.promise.then(fnc)\n        .then(nState => {\n          this.state = Object.assign({}, this.state, nState)\n\n          return this.state\n        })\n        .catch(error => {\n          if (critical || this.critical) {\n            this.critical = true\n            throw error\n          }\n          console.warn(error)\n          this.state = Object.assign({}, this.state, {error})\n          return this.state\n        })\n    \n    return this\n  }\n}\n\nfunction $pipe (fnc, state, critical) {\n  return new $pipePromise(fnc, state, critical)\n}\n\nfunction _generateState (seneca, msg) {\n  const notAllowedKeys = ['caller$', 'meta$', 'plugin$', 'tx$']\n  let nMsg             = {}\n\n  for (let key in msg) {\n    if (notAllowedKeys.indexOf(key) > -1) continue\n    nMsg[key] = msg[key]\n  }\n\n  return Object.assign({}, {seneca}, nMsg)\n}\n\nexport function doFn (fnc) {\n\n  return function (msg, done) {\n\n    const state = _generateState(this, msg)\n\n    let returnData = {}\n\n    tryFnc:\n      try {\n\n        const finalState = fnc($pipe, true, state)\n\n        if (!(finalState instanceof $pipePromise)) {\n          returnData = {ok : true, data : finalState}\n          break tryFnc\n        }\n\n        finalState.promise.then(finalState => {\n          done(null, {ok : true, data : finalState})\n        })\n                  .catch(err => {\n                    console.error(err)\n                    done(null, {ok : false, error : err})\n                  })\n        return\n      } catch (err) {\n        returnData = {ok : false, error : err}\n      }\n    \n    done(null, returnData)\n  }\n}"]}