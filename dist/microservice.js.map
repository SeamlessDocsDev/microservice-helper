{"version":3,"sources":["../lib/microservice.js"],"names":["doFn","$pipePromise","fnc","state","critical","promise","Promise","resolve","reject","fncCalled","Object","assign","then","_successHandler","fncState","catch","_errorHandler","error","nState","console","warn","scope","$pipe","_generateState","seneca","msg","notAllowedKeys","nMsg","key","indexOf","done","returnData","tryFnc","finalState","ok","data","err"],"mappings":"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","file":"microservice.js","sourcesContent":["/**\n *  Microservices pipeline.\n * @module\n */\n\n// NOTE: we need to remove no-labels for this project, try to avoid this kind of fixes\n/* eslint-disable no-labels */\n\nimport { printModule } from './debug'\n\nclass $pipePromise {\n  /**\n   * Basic Promise object that is transported across de pipeline\n   * @param {Function} fnc - Function to execute in the pipeline\n   * @param {Object} state - Current state of the App\n   * @param {boolean} [critical] - When $critical is present, an exception stop de pipe execution\n   */\n  constructor (fnc, state, critical) {\n    this.state = state\n    this.promise = new Promise((resolve, reject) => {\n      try {\n        const fncCalled = fnc(Object.assign({}, this.state))\n\n        if (!(typeof fncCalled.then === 'function')) {\n          return this._successHandler(fncCalled, resolve)\n        }\n\n        return fncCalled.then(fncState => {\n          return this._successHandler(fncState, resolve)\n        })\n          .catch(error => {\n            return this._errorHandler(error, critical, reject, resolve)\n          })\n      } catch (error) {\n        return this._errorHandler(error, critical, reject, resolve)\n      }\n    })\n  }\n\n  _successHandler (nState, resolve) {\n    this.state = Object.assign({}, this.state, nState)\n    return resolve(this.state)\n  }\n\n  _errorHandler (error, critical, reject, resolve) {\n    if (critical || this.critical) {\n      this.critical = true\n      return reject(error)\n    }\n    console.warn(error)\n    this.state = Object.assign({}, this.state, {error})\n    return resolve(this.state)\n  }\n\n  then (fnc, critical) {\n    this.promise = this.promise.then(fnc)\n      .then(nState => {\n        this.state = Object.assign({}, this.state, nState)\n\n        return this.state\n      })\n      .catch(error => {\n        if (critical || this.critical) {\n          this.critical = true\n          throw error\n        }\n        console.warn(error)\n        this.state = Object.assign({}, this.state, {error})\n        return this.state\n      })\n\n    return this\n  }\n\n  debug (scope = 'default') {\n    return this.then(printModule(scope))\n  }\n}\n/**\n *\n * @param {Function} fnc Function to execute in the pipeline.\n * @param {Object} state Current state of the App.\n * @param {boolean} [critical] When $critical is present, an exception stop de pipe execution.\n * @returns {$pipePromise}\n */\nfunction $pipe (fnc, state, critical) {\n  return new $pipePromise(fnc, state, critical)\n}\n\nfunction _generateState (seneca, msg) {\n  const notAllowedKeys = ['caller$', 'meta$', 'plugin$', 'tx$']\n  let nMsg = {}\n\n  for (let key in msg) {\n    if (notAllowedKeys.indexOf(key) > -1) continue\n    nMsg[key] = msg[key]\n  }\n\n  return Object.assign({}, {seneca}, nMsg)\n}\n/**\n * Wrapper function. If all is ok, the result will be { ok : true , data : {result} }\n * When is an error in business logic, the result will be { ok : false, err : Error }.\n * @param {Function} fnc Command function that must be executed.\n * @returns {Object}\n */\nexport function doFn (fnc) {\n  return function (msg, done) {\n    const state = _generateState(this, msg)\n\n    let returnData = {}\n\n    tryFnc:\n      try {\n        const finalState = fnc($pipe, true, state)\n\n        if (!(finalState instanceof $pipePromise)) {\n          returnData = {ok: true, data: finalState}\n          break tryFnc\n        }\n\n        finalState.promise.then(finalState => {\n          done(null, {ok: true, data: finalState})\n        })\n          .catch(err => {\n            console.error(err)\n            done(null, {ok: false, error: err})\n          })\n        return\n      } catch (err) {\n        returnData = {ok: false, error: err}\n      }\n\n    done(null, returnData)\n  }\n}\n"]}