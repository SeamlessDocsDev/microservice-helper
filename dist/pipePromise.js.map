{"version":3,"sources":["../lib/pipePromise.js"],"names":["$pipe","$pipePromise","fnc","state","critical","cloneDeep","promise","Promise","resolve","reject","process","nextTick","JSON","parse","stringify","seneca","key","match","fncReturn","then","catch","_successHandler","fncState","_errorHandler","error","nState","merge","env","NODE_ENV","DEBUG","console","warn","conditionalFnc","successPipeFnc","failPipeFnc","pipeFnc","params","length","dir","param","get","err","push","hasOwnProperty"],"mappings":"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","file":"pipePromise.js","sourcesContent":["/**\n *  $pipePromise.\n * @module\n */\nimport _ from 'lodash'\n\nexport class $pipePromise {\n  /**\n   * Basic Promise object that is transported across de pipeline\n   * @param {Function} fnc - Function to execute in the pipeline\n   * @param {Object} state - Current state of the App\n   * @param {boolean} [critical] - When $critical is present, an exception stop de pipe execution\n   */\n  constructor (fnc, state, critical) {\n    this.state = _.cloneDeep(state)\n    this.promise = new Promise((resolve, reject) => {\n      process.nextTick(() => {\n        try {\n          let state = JSON.parse(JSON.stringify(this.state))\n          state.seneca = this.state.seneca\n          for (let key in this.state) {\n            if (!key.match(/raw$/i)) continue\n            state[key] = this.state[key]\n          }\n\n          const fncReturn = fnc(state)\n\n          if (!fncReturn || typeof fncReturn.then !== 'function' || typeof fncReturn.catch !== 'function') {\n            return this._successHandler(fncReturn, resolve)\n          }\n\n          return fncReturn.then(fncState => {\n            return this._successHandler(fncState, resolve)\n          })\n            .catch(error => {\n              return this._errorHandler(error, critical, reject, resolve)\n            })\n        } catch (error) {\n          return this._errorHandler(error, critical, reject, resolve)\n        }\n      })\n    })\n  }\n\n  _successHandler (nState, resolve) {\n    this.state = _.merge(this.state, nState)\n    return resolve(this.state)\n  }\n\n  _errorHandler (error, critical, reject, resolve) {\n    if (critical || this.critical) {\n      this.critical = true\n      return reject(error)\n    }\n\n    if (process.env.NODE_ENV === 'production' || process.env.DEBUG) console.warn(error)\n\n    this.state.error = error\n    return resolve(this.state)\n  }\n\n  then (fnc, critical) {\n    this.promise = this.promise.then((state) => {\n      return (new $pipePromise(fnc, state, critical)).promise\n    })\n      .then(nState => {\n        this.state = _.merge(this.state, nState)\n\n        return this.state\n      })\n      .catch(error => {\n        if (critical || this.critical) {\n          this.critical = true\n          throw error\n        }\n\n        if (process.env.NODE_ENV === 'production' || process.env.DEBUG) console.warn(error)\n        this.state.error = error\n        return this.state\n      })\n\n    return this\n  }\n\n  if (conditionalFnc, successPipeFnc, failPipeFnc, critical) {\n    critical = typeof failPipeFnc !== 'function' ? failPipeFnc : critical\n    failPipeFnc = typeof failPipeFnc === 'function' ? failPipeFnc : () => {}\n\n    return this.then((state) => {\n      if (conditionalFnc(state)) return successPipeFnc(state)\n\n      return failPipeFnc(state)\n    }, critical)\n  }\n\n  use (pipeFnc, critical) {\n    return this.then((state) => {\n      return pipeFnc($pipe, true, state).promise\n    }, critical)\n  }\n\n  debug (...params) {\n    return this.then((state) => {\n      if (params.length === 0) {\n        console.dir(state)\n        return {}\n      }\n\n      for (let param of params) {\n        console.dir(_.get(state, param))\n      }\n      return {}\n    })\n  }\n\n  finally (fnc) {\n    let err\n\n    this.promise = this.promise.catch((error) => {\n      err = error\n      return error\n    }).then(() => {\n      return (new $pipePromise(fnc, this.state, true)).promise\n        .then(() => {\n          if (err) throw err\n\n          return this.state\n        })\n    })\n\n    return this\n  }\n\n  return (...params) {\n    this.promise = this.promise.then(() => {\n      params.push('error')\n      let state = {}\n\n      for (let param of params) {\n        if (!this.state.hasOwnProperty(param)) continue\n\n        state[param] = _.get(this.state, param)\n      }\n      this.state = state\n      return state\n    })\n\n    return this\n  }\n}\n\n/**\n *\n * @param {Function} fnc Function to execute in the pipeline.\n * @param {Object} state Current state of the App.\n * @param {boolean} [critical] When $critical is present, an exception stop de pipe execution.\n * @returns {$pipePromise}\n */\nexport function $pipe (fnc, state, critical) {\n  return new $pipePromise(fnc, state, critical)\n}\n"]}